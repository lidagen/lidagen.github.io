## 服务治理——Dubbo运用

### 背景介绍
随着互联网的发展，网站应用的规模不断扩大，常规的垂直应用架构已无法应对，分布式服务架构以及流动计算架构势在必行，亟需一个治理系统确保架构有条不紊的演进。

+ 单一应用架构
  - 当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。此时，用于简化增删改查工作量的数据访问框架(ORM)是关键。

+ 垂直应用架构
  - 当访问量逐渐增大， 单一应用增加机器带来的加速度越来越小， 将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的 Web 框架(MVC)是关键。

+ 分布式服务架构
  - 当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键。

+ 流动计算架构
  - 当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心
(SOA)是关键  

### 什么是Dubbo
了解 dubbo 之前，了解一下什么是 RPC？

+ RPC(Remote Procedure Call Protocol)：远程过程调用。 两台服务器 A、B，分别部署不同的应用a,b。当应用 a 需要调用应用 b 提供的函数或方法的时候，由于不在一个内存空间，不能直接调用，需要通过网络来表达调用的语义传达调用的数据。

#### RPC需要解决的问题
+ **通讯问题**：主要是通过在客户端和服务器之间建立 TCP 连接，远程过程调用的所有交换的数据都在这个连接里传输。连接可以是按需连接，调用结束后就断掉，也可以是长连接，多个远程过程调用共享同一个连接。

+ **寻址问题** ：A 服务器上的应用怎么告诉底层的 RPC 框架，如何连接到 B 服务器（如主机或 IP 地址）以及特定的端口，方法的名称名称是什么，这样才能完成调用。比如基于 Web 服务协议栈的 RPC，就要提供一个 endpoint URI，或者是从 UDDI 服务上查找。如果是 RMI 调用的话，还需要一个 RMI Registry 来注册服务的地址。

+ **序列化与反序列化**：当 A 服务器上的应用发起远程过程调用时， 方法的参数需要通过底层的网络协议如 TCP 传递到 B
服务器，由于网络协议是基于二进制的，内存中的参数的值要序列化成二进制的形式，也就是序列化（Serialize）或编组（marshal），通过寻址和传输将序列化的二进制发送给 B 服务器。 同理，B 服务器接收参数要将参数反序列化。B 服务器应用调用自己的方法处理后返回的结果也要序列化给 A 服务器，A 服务器接收也要经过反序列化的过程。

### Dubbo简介

**dubbo是：**
+ 一款分布式服务框架
+ 高性能和透明的RPC远程调用方案
+ SOA服务治理方案


**dubbo架构图：**
<img :src="$withBase('/dubbo/1.png')" alt="dock">

**dubbo包含几部分：**
+ Provider：暴露服务的提供方
+ Consumer: 调用远程服务的服务消费方
+ Registry: 服务注册和发现中心
+ Monitor: 统计服务的调用次数和调用时间的监控中心
+ Container: 服务运行容器

调用关系说明：
+ 0. 服务容器负责启动，加载，运行服务提供者。
+ 1. 服务提供者在启动时，向注册中心注册自己提供的服务。
+ 2. 服务消费者在启动时，向注册中心订阅自己所需的服务。
+ 3. 注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。
+ 4. 服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。
+ 5. 服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。

### 环境准备（window 环境）
+ git _下载项目
+ maven _后端打包
+ jdk _运行jar
+ node _npm下载包
+ webpack _前端打包

#### 下载zookeeper并配置启动
+ [官网](https://www.apache.org/dyn/closer.cgi/zookeeper/)进入，选择HTTP点击下载ZIP包（本文下载的3.4.14版本）。

+ 解压到本地后，找到conf文件夹，修改zoo_sample.cfg中`dataDir`指向本地安装路径。（本例子dataDir=D:\dubboSoft\zookeeper-3.4.14）

+ 修改bin目录下zkEnv.cmd中ZOOCFG指向刚修改的zoo_sample.cfg文件(set ZOOCFG=%ZOOCFGDIR%\zoo_sample.cfg)

+ 点击zkServive.cmd和zkCli.cmd启动。

#### 下载Dubbo——前后端构建打包启动
+ git 克隆 dubbo代码 `git clone https://github.com/apache/dubbo-admin`

+ dubbo-admin-server 目录下 cmd 运行 `mvn package`打包 dubbo-admin-server模块，会在此文件夹下target生成jar包。

+ 进入jar包所在target目录,cmd 运行命令 `java -jar dubbo-admin-server-0.1.jar` 启动jar，之后访问 http://localhost:8080/swagger-ui.html 成功代表后端启动成功。

+ dubbo-admin-ui 目录下 cmd 运行命令 `npm i`对前端进行打包。

+ 完成后 `npm run dev`启动前端项目，访问  http://localhost:8081 进入Dubbo后台管理页面。

到此阶段，Dubbo需要的环境以及依赖安装就已经完成了，可以后续进行项目开发。
